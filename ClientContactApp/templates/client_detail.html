{% extends 'base.html' %}
{% block content %}
<h2>Client: {{ client.name }}</h2>
<p><b>Client Code:</b> {{ client.client_code }}</p>
<p><b>Created At:</b> {{ client.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
<hr>
<h3>Linked Contacts</h3>
{% if contacts %}
<table border="1">
    <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Action</th>
    </tr>
    {% for contact in contacts %}
    <tr id="contact-row-{{ contact.id }}">
        <td>{{ contact.name }} {{ contact.surname }}</td>
        <td>{{ contact.email }}</td>
        <td>
            <button class="unlink-btn" data-contact-id="{{ contact.id }}">Unlink</button>
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No Contacts found</p>
{% endif %}
<hr>
<h3>Link New Contact</h3>
<form id="link-contact-form">
    <select name="contact_id" id="contact_id">
        <option value="">-- Select Contact --</option>
        {% for contact in Contact.query.all() if contact not in contacts %}
        <option value="{{ contact.id }}">{{ contact.name }} {{ contact.surname }} ({{ contact.email }})</option>
        {% endfor %}
    </select>
    <button type="submit">Link</button>
</form>
<script>
$(function() {
    // Unlink contact AJAX
    $('.unlink-btn').click(function() {
        var cid = $(this).data('contact-id');
        $.post('{{ url_for("client.unlink_contact", client_id=client.id) }}', {contact_id: cid}, function(resp) {
            if (resp.success)
                $('#contact-row-' + cid).remove();
        });
    });
    // Link contact AJAX
    $('#link-contact-form').submit(function(e) {
        e.preventDefault();
        var contact_id = $('#contact_id').val();
        if(contact_id) {
            $.post('{{ url_for("client.link_contact", client_id=client.id) }}', {contact_id: contact_id}, function(resp) {
                if(resp.success) location.reload();
            });
        }
    });
});
</script>
{% endblock %}