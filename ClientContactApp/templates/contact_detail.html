{% extends 'base.html' %}
{% block content %}
<h2>Contact: {{ contact.name }} {{ contact.surname }}</h2>
<p><b>Email:</b> {{ contact.email }}</p>
<p><b>Created At:</b> {{ contact.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
<hr>
<h3>Linked Clients</h3>
{% if clients %}
<table border="1">
    <tr>
        <th>Client Name</th>
        <th>Client Code</th>
        <th>Action</th>
    </tr>
    {% for client in clients %}
    <tr id="client-row-{{ client.id }}">
        <td>{{ client.name }}</td>
        <td>{{ client.client_code }}</td>
        <td>
            <button class="unlink-btn" data-client-id="{{ client.id }}">Unlink</button>
        </td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No client(s) found</p>
{% endif %}
<hr>
<h3>Link to Client</h3>
<form id="link-client-form">
    <select name="client_id" id="client_id">
        <option value="">-- Select Client --</option>
        {% for client in Client.query.order_by(Client.name).all() if client not in clients %}
        <option value="{{ client.id }}">{{ client.name }} ({{ client.client_code }})</option>
        {% endfor %}
    </select>
    <button type="submit">Link</button>
</form>
<script>
$(function() {
    // Unlink client AJAX
    $('.unlink-btn').click(function() {
        var cid = $(this).data('client-id');
        $.post('{{ url_for("contact.unlink_client", contact_id=contact.id) }}', {client_id: cid}, function(resp) {
            if (resp.success)
                $('#client-row-' + cid).remove();
        });
    });
    // Link client AJAX
    $('#link-client-form').submit(function(e) {
        e.preventDefault();
        var client_id = $('#client_id').val();
        if(client_id) {
            $.post('{{ url_for("contact.link_client", contact_id=contact.id) }}', {client_id: client_id}, function(resp) {
                if(resp.success) location.reload();
            });
        }
    });
});
</script>
{% endblock %}